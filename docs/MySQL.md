# MySQL

## 初识MySQL

MySQL采用客户端/服务器架构,用户通过客户端程序发送增删改查请求,服务器程序收到请求后处理,并把处理结果返回给客户端.

---

MySQL安装目录的bin目录下存放了许多可执行文件,其中有一些是服务器程序(比如mysqld,mysqld_safe),有一些是客户端程序(比如mysql,mysqladmin).

在类UNIX系统上启动服务器程序的方式有下面这些:

- mysqld;
- mysqld_safe;
- mysql.server;
- mysqld_multi;

在Windows系统上启动服务器程序的方式有下面这些:

- mysqld;
- 将mysqld注册为Windows服务,用net start 服务名 启动

启动客户端程序的常用语法如下:

```sql
mysql -h 主机名 -u 用户名 -p 密码
```

---

客户端进程和服务器进程在通信时采用下面几种方式:

- TCP/IP
- 命名管道或共享内存(Windows)
- UNIX域套接字

---

以查询请求为例,服务器程序在处理客户端发送过来的请求时,大致分为一下几个部分:

- 连接管理: 主要负责连接的连理与信息的认证
- 解析与优化: 主要进行查询缓存,语法解析,查询优化
- 存储引擎: 主要负责读取和写入底层表中的数据

为了方便管理,通常把连接管理和解析优化划分为server层,把存取真实数据的功能划分为存储引擎层.

---

MySQL支持的存储引擎有很多,其中最常用的是InnoDB和MyISAM,InnoDB是MySQL的默认存储引擎

- 查看当前服务器程序支持的存储引擎:

```sql
SHOW ENGINES;
```

- 创建表时指定表的存储引擎:

```sql
CREATE TABLE TABLENAME(
    # 创建语句
) ENGINE = 存储引擎的名字;
```

- 修改表的存储引擎:

```sql
ALTER TABLE TABLENAME ENGINE = 存储引擎的名字;
```

## MySQL的启动选项和系统变量

## 存储引擎

|   异同   | InnoDB | MyISAM |
| :-----: | :-----: | :-----: |
| 事务 | 支持 | 不支持 |
| 外键 | 支持 | 不支持 |
| 锁级别 | 行锁 | 表锁 |
| MVCC | 支持 | 不支持 |
| 全文索引 | 不支持 | 支持 |
| 在线热备份 | 支持 | 不支持 |

!> InnoDB 存储引擎开始支持全文索引是在 MySQL 5.6 版本中。在此之前，全文索引只能由 MyISAM 存储引擎支持。

## 字符串和比较规则

## InnoDB记录存储结构

### 行结构

InnoDB存储引擎是面向行的，也就是说数据是按行进行存放的，按行存放的数据便是一条条的记录，这些记录在磁盘上的存放方式也被称为行格式或者记录格式。目前InnoDB中共有4中不同类型的行格式，分别为Compact、Redundant、Dynamic和Compressed行格式。

- Compact：这是MySQL 5.0.3及更高版本的默认行格式。与Redundant格式相比，Compact格式使用更少的存储空间。它使用更紧凑的方式存储null值和变长字段。

- Redundant：这是MySQL 5.0.3之前版本的默认行格式。每一行都有一个额外的字节，用于存储null值的信息。

- Dynamic：这是MySQL 5.7及更高版本的默认行格式。与Compact格式相比，Dynamic格式更有效地管理BLOB，TEXT，VARCHAR等变长字段。如果这些字段的长度超过768字节，Dynamic格式只在主页中存储768字节的前缀，剩余的部分存储在溢出页中。

- Compressed：这种格式与Dynamic格式类似，但它会对数据进行压缩，以节省存储空间。这需要在表空间级别启用压缩。

>在MySQL 5.7及更高版本中，InnoDB的默认行格式是DYNAMIC  
>在MySQL 5.6及更低版本中，InnoDB的默认行格式是COMPACT

以compact格式为例：一行数据结构如上图，分为额外信息和真实的列值数据两部分，额外信息中需要记录变长列的长度，因为是变长的无法提前知道长度，所以需要随着每条记录做标记；null值列表主要是null不会在数据部分做任何存储，只在这里存储列名；记录头信息内容比较多，比如有指向下一条记录的指针，deleted标等。

一行数据不能太长，最长是700多个字节，超出的部分就算溢出，当前数据记录一个指针，超出的部分单独放到溢出页，指针指过去，可能有多个溢出的列。

## InnoDB数据页结构

### 页结构

InnoDB存储引擎的数据是基于页（Page）的，每个页的大小默认为16KB，可以在初始化数据库时进行设置。每个页中包含了许多行数据以及其他的一些控制信息。

一个InnoDB的页的结构大致如下：

File Header：包含了该页的一些基本信息，如页类型、上一个页的位置（prev）、下一个页的位置（next）等。

Page Header：包含了该页的一些元数据，如记录的数量、记录的目录开始位置等。

Infimum+Supremum Records：两个特殊的记录，用于在页内形成一个记录的双向链表。  
Infimum Record：这是一个虚拟记录，它的值小于页中任何实际记录的值。Infimum记录存在于每个页中，用于初始化页的开始部分，并作为记录链表的起点。  
Supremum Record：这也是一个虚拟记录，它的值大于页中任何实际记录的值。Supremum记录存在于每个页中，用于初始化页的结束部分，并作为记录链表的终点。

User Records：用户的记录，即实际的行数据。

Free Space：未使用的空间。

Page Directory：记录的目录，用于加速对记录的查找。

File Trailer：页的尾部，主要是一些校验信息。

这只是InnoDB的页结构的基本概念，实际的结构会更复杂，涉及到更多的细节。

## B+树索引

## B+树索引的使用

## MySQL的数据目录

## InnoDB的表空间

### 区与段

## 单表访问方法

## 连接的原理

## 基于成本的优化

## InnoDB统计数据是如何收集的

## 基于规则的优化

## EXPLAIN详解

## InnoDB的Buffer Pool

## 事务简介

在 MySQL 中，事务（Transaction）是一个不可分割的工作单位。在同一事务中的一系列数据库操作，要么全部执行成功，要么全部执行失败。事务是用来保证数据一致性的重要机制。

事务具有以下四个基本特性（ACID 特性）：

1. 原子性（Atomicity）：事务是一个原子操作单元，其对数据的修改，要么全都执行，要么全都不执行。

2. 一致性（Consistency）：事务开始前和结束后，数据库的完整性约束没有被破坏。这是指写入的数据必须满足所有的预定义规则，例如数据类型、长度或者是用户自定义的规则。

3. 隔离性（Isolation）：数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。事务隔离分为不同级别，包括读未提交、读提交、可重复读、串行化。

4. 持久性（Durability）：一旦事务完成，则其结果就能够永久的保存在数据库中。即使系统发生崩溃，重新启动后，数据库还能恢复到事务成功结束的状态。

## redo日志

## undo日志

## 事务隔离级别和MVCC

### 隔离级别

SQL标准中的四种隔离级别如下：

!> MySQL 的默认隔离级别是：可重复读（REPEATABLE READ）

- 脏读（Dirty Read）：在同一事务中，一个事务读取到了另一个事务中未提交的数据，另一个事务如果回滚或进行更改会导致数据读取错误

- 不可重复读（Non-Repeatable Read）：在同一事务中，一个查询在不同时间点多次读取同一行或多行数据，却得到了不同的结果。这是因为在两次读取之间，另一个事务修改了这行数据并提交。

- 幻读（Phantom Read）：在同一事务中，一个查询在不同时间点多次执行，第一次和后续的查询返回的行数不同，或者后续查询能读取到第一次查询中不存在的行。这是因为在两次查询之间，另一个事务插入或删除了一些行并提交。

## 锁
